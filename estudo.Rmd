---
title: "Estudo"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r setup}
library(tidyverse)
library(readxl)

```

# Comércio

## Participação nos fluxos de comércio

### Participação nas exportações

```{r dados de participação de comercio}
exp_participacao <- comerciobr::sh1_df %>% 
  filter(co_ano == max(co_ano)-1) %>% 
  filter(path == "EXP") %>% 
  group_by(no_pais) %>% 
  summarise(exportacoes = sum(value)) %>% 
  ungroup() %>% 
  mutate(total = sum(exportacoes)) %>% 
  mutate(porcentagem_exportacoes = exportacoes/total)

```

```{r}
exp_participacao %>% 
  slice_max(porcentagem_exportacoes, n = 10) %>% 
  mutate(no_pais = fct_reorder(no_pais, porcentagem_exportacoes, sum)) %>% 
  ggplot() +
  geom_col(aes(porcentagem_exportacoes, no_pais)) +
  scale_x_continuous(labels = scales::label_percent()) +
  labs(title = "Participação das exportações totais, por país",
       subtitle = "em 2020",
       caption = "Fonte: Ministério da Economia",
       x = NULL, y = NULL
       )

```

### Participação nas importações

```{r}
imp_participacao <- comerciobr::sh1_df %>% 
  filter(co_ano == max(co_ano)-1) %>% 
  filter(path == "IMP") %>% 
  group_by(no_pais) %>% 
  summarise(importacoes = sum(value)) %>% 
  ungroup() %>% 
  mutate(total = sum(importacoes)) %>% 
  mutate(porcentagem_importacoes = importacoes/total)
```

```{r}
imp_participacao %>% 
  slice_max(porcentagem_importacoes, n = 20) %>% 
  mutate(no_pais = fct_reorder(no_pais, porcentagem_importacoes, sum)) %>% 
  ggplot() +
  geom_col(aes(porcentagem_importacoes, no_pais)) +
  scale_x_continuous(labels = scales::label_percent()) +
  labs(title = "Participação das exportações totais, por país",
       subtitle = "em 2020",
       caption = "Fonte: Ministério da Economia",
       x = NULL, y = NULL
       )


```

### Participação na corrente de comércio

```{r}
corrente_participacao <- comerciobr::sh1_df %>% 
  filter(co_ano == max(co_ano)-1) %>% 
  group_by(path, no_pais) %>% 
  summarise(value = sum(value)) %>% 
  pivot_wider(names_from = path, values_from = value) %>% 
  mutate(corrente = EXP + IMP,
         saldo = EXP - IMP) %>% 
  select(no_pais, corrente) %>% 
  drop_na() %>% 
  mutate(total = sum(corrente)) %>% 
  mutate(porcentagem_corrente = corrente/total)

```

```{r}
corrente_participacao %>% 
  slice_max(porcentagem_corrente, n = 20) %>% 
  mutate(no_pais = fct_reorder(no_pais, porcentagem_corrente, sum)) %>% 
  ggplot() +
  geom_col(aes(porcentagem_corrente, no_pais)) +
  scale_x_continuous(labels = scales::label_percent()) +
  labs(title = "Participação da corrente de comércio, por país",
       subtitle = "em 2020",
       caption = "Fonte: Ministério da Economia",
       x = NULL, y = NULL
       )

```

Estou na dúvida de como tratar os saldos comerciais, na medida em que eles podem ser negativos e positivos. Não acho que a melhor maneira de tratar esses dados, da perspectiva do índice, seja através da porcentagem. É preciso encontrar melhor maneira para lidar com esses dados.


## Comércio Intraindústria

# Tecnologia

## Depósitos de Patentes

```{r dados de patentes}
patentes <- read_excel("data/deposito_patentes_tipo_pi_por_pais.xls", skip = 7) %>% 
  rename(País = 1) %>% 
  select(-c(2)) %>% 
  pivot_longer(cols = 2:last_col(), names_to = "ano", values_to = "patentes") %>% 
  drop_na()


```

Os dados de patentes selecionados foram adquiridos no endereço eletrônico do [INPI, setor de estatísticas](https://www.gov.br/inpi/pt-br/central-de-conteudo/estatisticas), particularmente o setor de "Indicadores de Propriedade Intelectual". Foi feito o download das tabelas completas do último ano disponível, 2019. Dentre os mais variados indicadores disponíveis, foi escolhido o seguinte indicador: **Depósito de patentes tipo Patentes de Invenção, por país de origem**. As tabelas indicam a quantidade dos pedidos de patentes de 2000 até o último ano disponível.

Para fins deste estudo, considerou-se que os dados de pedidos de patente relativos ao último ano disponível pode apresentar oscilação nos dados - a depender do ano, o número de patentes solicitado pode variar bastante. Por isso, para evitar a variação, optou-se pela soma de todos os pedidos de patente, por país, desde o início da série temporal, no ano de 2000. 

```{r}
total_patentes <- patentes %>% 
  filter(País != "Brasil") %>% 
  drop_na() %>% 
  group_by(País) %>% 
  summarise(patentes = sum(patentes)) %>% 
  ungroup() %>% 
  mutate(total = sum(patentes)) %>% 
  mutate(porcentagem = round((patentes/total), 2)) %>% 
  arrange(desc(porcentagem))

```



```{r}
total_patentes %>%
  slice_max(patentes, n = 30) %>%
  mutate(País = fct_reorder(País, patentes)) %>% 
  ggplot() +
  geom_col(aes(porcentagem, País)) +
  scale_x_continuous(labels = scales::label_percent()) +
  labs(title = "Total de pedidos de patentes tipo patentes de invenção",
       subtitle = "Entre 2000 e 2019",
       caption = "Fonte: INPI",
       x = NULL, y = NULL)
```



# Investimentos

## Banco Central

### Dados de estoque, Controlador Final

```{r}

controlador_final_investimentos <- investimentos::bc_idp_pais_controlador %>% 
  filter(discriminacao != "Total") %>% 
  filter(ano == max(ano)) %>% 
  drop_na() %>% 
  mutate(total = sum(value)) %>% 
  mutate(porcentagem = value/total) %>% 
  mutate(discriminacao = fct_reorder(discriminacao, porcentagem, sum))
```

```{r}
controlador_final_investimentos %>% 
  slice_max(porcentagem, n = 30) %>% 
  ggplot() +
  geom_col(aes(porcentagem, discriminacao))
```

## Fluxos para o Brasil - comparação mundo-país

1. Porcentagem dos fluxos mundiais de investimento recebidos pelo Brasil, por ano.

2. Porcentagem dos fluxos de um determinado país de investimento recebido pelo Brasil, por ano

2.1 dados da OCDE
2.2 dados do Brasil

3. Calcular a diferença entre os dois.

### UNCTAD - fluxos mundiais de investimento recebidos pelo Brasil, por ano


```{r}
unctad <- read_csv("data/unctad_fdi_flows_stock_2020.csv")

# ied no brasil, como porcentagem do mundo, por ano

idp_brasil_pct_mundo <- unctad %>% 
  janitor::clean_names() %>% 
  filter(economy_label == "Brazil") %>% 
  filter(direction_label == "Inward") %>% 
  filter(mode_label == "Flow") %>% 
  filter(year == max(year)) %>% 
  select(percentage_of_total_world, year)

unctad %>% 
  janitor::clean_names() %>% 
  # filter(economy_label == "Brazil") %>% 
  filter(direction_label == "Outward") %>% 
  filter(mode_label == "Flow") %>% 
  filter(str_length(economy) == 3) %>% 
  select(year, economy, economy_label, percentage_of_total_world) 

```


### OCDE - fluxos de investimentos, por país

```{r}
ocde_investimentos <- vroom::vroom("data/ocde_fdi_flows_stocks_partners.csv")

ocde_investimentos_brasil <- ocde_investimentos %>% 
  janitor::clean_names() %>% 
  filter(year == max(year)) %>% 
  filter(currency == "US Dollar") %>% 
  filter(partner_country_territory == "Brazil") %>% 
  filter(type_of_fdi == "FDI positions -Total") %>% 
  filter(measure_principle == "DO") %>% 
  select(reporting_country, power_code, value, flag_codes, flags)

ocde_investimentos_total <- ocde_investimentos %>% 
  janitor::clean_names() %>% 
  filter(year == max(year)) %>% 
  filter(currency == "US Dollar") %>% 
  filter(type_of_fdi == "FDI positions -Total") %>% 
  filter(partner_country_territory == "WORLD") %>% 
  filter(measure_principle == "DO") %>% 
  filter(economic_activity == "All FDI activities") %>% 
  rename(total_fdi = value) %>% 
  select(reporting_country, total_fdi)

ocde_investimentos_brasil %>% 
  left_join(ocde_investimentos_total) %>% 
  mutate(porcentagem = value/total_fdi) %>% 
  arrange(desc(porcentagem)) %>% 
  mutate(reporting_country = fct_reorder(reporting_country, porcentagem, sum)) %>% 
  mutate(porcentagem = porcentagem*100) %>% 
  select(-c(flag_codes, flags)) %>% 
  drop_na() %>%
  ggplot() +
  geom_col(aes(porcentagem, reporting_country)) +
  geom_vline(xintercept = idp_brasil_pct_mundo$percentage_of_total_world, linetype = 2) +
  ggplot2::annotate("text", x = idp_brasil_pct_mundo$percentage_of_total_world, y = 10, label = "teste")

```

### Dados do Banco Central

Dados pelo controlador final.

```{r}
investimentos_banco_central <- investimentos::bc_idp_pais_controlador %>% 
  filter(discriminacao != "Total") %>% 
  filter(ano == max(ano)) %>% 
  drop_na() %>% 
  mutate(total = sum(value)) %>% 
  mutate(porcentagem = value/total)
```

```{r}
investimentos_banco_central %>% 
  mutate(discriminacao = fct_reorder(discriminacao, porcentagem, sum)) %>% 
  ggplot() +
  geom_col(aes(porcentagem, discriminacao))

```


# Emprego
# Financiamento

Quadro 12 - Participação estrangeira no capital votante de instituições do SFN

https://www.bcb.gov.br/content/publicacoes/evolucaosfn/r202012/T4CE_Quadro%2012%20-%20Participa%C3%A7%C3%A3o%20estrangeira%20no%20capital%20votante%20de%20institui%C3%A7%C3%B5es%20do%20SFN.pdf

https://www.bcb.gov.br/publicacoes/relatorioevolucaosfnano

## Empréstimos diretos de longo prazo - passivos

- Dados em US$ Milhões
- Dados indicam os ingressos anuais de financiamento externo em US $ milhões.
```{r}
emprestimos <- read_excel("data/EmprestimosDiretosLongoPrazoPassivop.xls", skip = 4)

emprestimos_tidy <- emprestimos %>% 
  drop_na() %>% 
  # janitor::clean_names() %>% 
  filter(Discriminação != "Total") %>% 
  mutate(across(.cols = 2:dplyr::last_col(), as.numeric)) %>% 
  pivot_longer(cols = 2:dplyr::last_col(), names_to = "ano", values_to = "value") %>% 
  filter(!is.na(value))
```

```{r}
emprestimos_tidy %>% 
  filter(ano == max(ano)) %>% 
  arrange(desc(value))
  ggplot(aes(value, reorder(Discriminação, value))) +
  geom_point()
```


Empréstimos diretos de longo prazo passivos

https://www.bcb.gov.br/content/estatisticas/Documents/Tabelas_especiais/EmprestimosDiretosLongoPrazoPassivop.xls

## Endividamento em moeda estrangeira

Dívida externa - distribuição por moeda

https://www.bcb.gov.br/content/estatisticas/Documents/Tabelas_especiais/DivMoeda_T.xlsx


# Tentando arrumar os nomes

- Os nomes usados como base serão sempre os nomes de comércio que estão no pacote comtrade. 

```{r}
comerciomundo::dic_comtrade_mdic

# https://gist.github.com/jjesusfilho/cee5670f8c68ec82f5bdb2fc1d44d1d4
# A referência é o segundo vetor.
busca_fuzzy<-function(x,y){
  
  `%>%` <- magrittr::`%>%`  

  
  x1 <- x %>% 
    stringi::stri_trans_general("latin-ascii") %>% 
    stringi::stri_trans_tolower() %>% 
    stringi::stri_trim_both() %>% 
    stringi::stri_replace_all_regex("\\s+","_")
  
  y1 <- y %>% 
    stringi::stri_trans_general("latin-ascii") %>% 
    stringi::stri_trans_tolower() %>% 
    stringi::stri_trim_both() %>% 
    stringi::stri_replace_all_regex("\\s+","_")
  
  purrr::map(x1, ~{
    
    a <- stringdist::stringdist(.x,y1)
    
    b <- which.min(a)
    
    d <- y[b]
  
  }) %>% 
    unlist()
  
}

nomes_patentes <- patentes %>% 
  mutate(nome_corrigido = case_when(País == busca_fuzzy(País, comerciomundo::dic_comtrade_mdic$no_pais) ~ País,
                                    TRUE ~ "A CORRIGIR")) %>% 
  select(nome_corrigido, País) %>% 
  rename(no_pais = nome_corrigido, pais_patente = País) %>% 
  distinct()

nomes_investimentos_bancocentral <- controlador_final_investimentos %>% 
  mutate(discriminacao = as.character(discriminacao)) %>% 
  mutate(nome_corrigido = case_when(discriminacao == busca_fuzzy(discriminacao, comerciomundo::dic_comtrade_mdic$no_pais) ~ discriminacao,
                                    TRUE ~ "A CORRIGIR")) %>% 
  select(nome_corrigido, discriminacao) %>% 
  rename(no_pais = nome_corrigido, pais_bancocentral = discriminacao) %>% 
  distinct()


comerciomundo::dic_comtrade_mdic %>% 
  left_join(nomes_patentes) %>% 
  left_join(nomes_investimentos_bancocentral)
  # filter(nome_corrigido != País) %>% 
  # View()


nomes_patentes_a_corrigir <- patentes %>% 
  mutate(nome_corrigido = case_when(País == busca_fuzzy(País, comerciomundo::dic_comtrade_mdic$no_pais) ~ País,
                                    TRUE ~ "a corrigir")) %>% 
  filter(nome_corrigido == "teste") %>% 
  distinct(País) %>% 
  pull()
  View()
  as_tibble()
```

```{r}

library(stringdist)
stringdist::stringdist()

busca_fuzzy(unique(patentes$País)[1:158], corrente_participacao$no_pais)

corrente_participacao$no_pais
unique(patentes$País)[1:158]




```

